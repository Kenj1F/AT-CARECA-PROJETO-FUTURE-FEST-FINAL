<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visão do Futuro</title>
  <link rel="stylesheet" href="style4.css">
  <style>
    body {
  margin: 0;
  padding: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #4b0082, #6a0dad);
  background-size: 20px 20px;
  background-image: linear-gradient(30deg, rgba(255, 255, 255, 0.1) 12%, transparent 12.5%, transparent 87%, rgba(255, 255, 255, 0.1) 87.5%, rgba(255, 255, 255, 0.1)),
                    linear-gradient(120deg, rgba(255, 255, 255, 0.1) 12%, transparent 12.5%, transparent 87%, rgba(255, 255, 255, 0.1) 87.5%, rgba(255, 255, 255, 0.1));
  background-position: 0 0, 10px 10px;
  font-family: Arial, sans-serif;
}

.container {
  position: relative;
  width: 100%;
  max-width: 600px;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.card {
  background-color: transparent;
  color: white;
  padding: 20px;
  width: 80%;
  max-width: 400px;
}

.character-speech {
  background-color: #2a2a72;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 1.1em;
  text-align: left;
}

.input-container {
  position: relative;
  margin-bottom: 20px;
}

.vision-input {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 10px;
  background-color: #2a2a72;
  color: white;
  font-size: 1em;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
}

.vision-input::placeholder {
  color: #d3d3d3;
}

.mic-icon {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  background-color: #fff;
  border-radius: 50%;
  display: inline-block;
  cursor: pointer;
}

.mic-icon::after {
  content: '';
  position: absolute;
  top: 30%;
  left: 50%;
  transform: translateX(-50%);
  width: 8px;
  height: 8px;
  background-color: #000;
  border-radius: 50%;
}

.mic-icon.active {
  background-color: #00ff00; /* Cor quando ativo, opcional */
}

.generate-button {
  background-color: #d8bfd8;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  font-size: 1em;
  cursor: pointer;
  color: #333;
  font-weight: bold;
  width: 150px;
}

.generate-button:hover {
  background-color: #c0a0c0;
}

.back-button {
  position: absolute;
  top: 20px;
  left: 20px;
  background-color: #b0c4de;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  font-size: 1em;
  cursor: pointer;
  color: #333;
  font-weight: bold;
}

.back-button:hover {
  background-color: #a2b5cd;
}

.sidebar {
  position: absolute;
  right: 0px;
  top: 80%;
  transform: translateY(-50%);
  width: 100px;
  height: 200px;
  background-color: #1a1a1a;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  z-index: 0;
}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-button">Voltar</button>
    <div class="card">
      <p class="character-speech">Fala do personagem: Olá, tudo bem?</p>
      <div class="input-container">
        <input type="text" placeholder="Descreva sua visão do futuro" class="vision-input" id="visionInput">
        <span class="mic-icon" id="micButton"></span>
                <div class="content">
            <div style="margin-bottom: 20px;">
                <a href="/pergunta_nome.html">
                    <button class="btn btn-secondary">
                        ← Voltar
                    </button>
                </a>
            </div>
                       <audio id="audioPersonalizado" controls style="width: 100%; max-width: 400px; margin: 0 auto; border-radius: 8px; background-color: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <source src="" type="audio/mpeg">
                    Seu navegador não suporta o elemento de áudio.
                </audio>
      </div>
            <form id="formMundo" onsubmit="return false;">
                <div class="form-group">
                    <label for="mundoPerfeito" class="form-label">Descreva sua visão:</label>
                    <textarea name="mundo_perfeito" id="mundoPerfeito" placeholder="Ex: Um mundo com muitas árvores, animais livres, tecnologia sustentável, pessoas felizes..." required></textarea>
                </div>
                <button type="submit" class="btn" id="btnGerar">✨ Gerar Mundo Perfeito</button>
            </form>
    </div>
    <div class="sidebar"></div>
  </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obter parâmetros da URL
            const urlParams = new URLSearchParams(window.location.search);
            const nomeUsuario = urlParams.get('nome');

            // Exibir o nome
            document.getElementById('nomeExibido').textContent = nomeUsuario || 'Usuário';

            // Carregar áudio personalizado se o nome existir
            if (nomeUsuario) {
                const audioEl = document.getElementById('audioPersonalizado');
                const sourceEl = audioEl.querySelector('source');
                
                // Configurar o src do áudio
                sourceEl.src = `http://127.0.0.1:5000/audio_personalizado/${encodeURIComponent(nomeUsuario)}`;
                
                // Aguardar o áudio carregar antes de tentar reproduzir
                audioEl.addEventListener('canplay', function() {
                    setTimeout(() => {
                        audioEl.play().catch(err => {
                            console.log('Reprodução automática bloqueada:', err);
                        });
                    }, 300);
                }, { once: true });
                
                // Carregar o áudio (pode demorar se for gerar pela primeira vez)
                audioEl.load();
                
                // Fallback: tentar reproduzir após 2 segundos mesmo se canplay não disparar
                setTimeout(() => {
                    if (audioEl.readyState >= 2) {
                        audioEl.play().catch(err => {
                            console.log('Reprodução automática bloqueada:', err);
                        });
                    }
                }, 2000);
            }

            // Interceptar submit do formulário para gerar imagem
            const formMundo = document.getElementById('formMundo');
            formMundo.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const mundoPerfeito = document.getElementById('mundoPerfeito').value;
                const loading = document.getElementById('loading');
                const btnGerar = document.getElementById('btnGerar');
                
                if (!mundoPerfeito.trim()) {
                    alert('Por favor, descreva sua visão do mundo perfeito.');
                    return;
                }
                
                // Mostrar loading e desabilitar botão
                loading.style.display = 'block';
                btnGerar.disabled = true;
                btnGerar.textContent = '⏳ Gerando...';
                
                try {
                    // Fazer requisição POST para gerar imagem
                    const response = await fetch('http://127.0.0.1:5000/gerar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            nome: nomeUsuario || 'Usuário',
                            mundo_perfeito: mundoPerfeito
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Redirecionar para resultado com a URL da imagem
                        window.location.href = `/resultado.html?nome=${encodeURIComponent(data.nome)}&mundo_perfeito=${encodeURIComponent(data.mundo_perfeito)}&imagem_url=${encodeURIComponent(data.imagem_url)}`;
                    } else {
                        alert('Erro: ' + (data.erro || 'Erro desconhecido'));
                        loading.style.display = 'none';
                        btnGerar.disabled = false;
                        btnGerar.textContent = '✨ Gerar Mundo Perfeito';
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao conectar com o servidor. Certifique-se de que o Flask está rodando!');
                    loading.style.display = 'none';
                    btnGerar.disabled = false;
                    btnGerar.textContent = '✨ Gerar Mundo Perfeito';
                }
            });
        });
    </script>
</body>
</html>